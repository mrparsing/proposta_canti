<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/style_index.css">
    <script src="javascript/theme.js"></script>
    <script src="javascript/javascript.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <title>Proposta Cantixs</title>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            setNavbarColor(festivita[0].tipologia);
            setDarkTheme();

            document.getElementById('download').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const element = document.querySelector('.responsive-container');

                // Get the text content of the element
                const textContent = element.innerText || element.textContent;

                // Log the text content
                console.log(textContent);

                // Define the maximum width for text to be wrapped
                const maxWidth = 190; // Adjust based on your margin preferences
                const marginTop = 10; // Top margin
                const marginBottom = 10; // Bottom margin
                const lineHeight = 10; // Height of each line

                // Split the text into lines that fit within the specified max width
                const lines = doc.splitTextToSize(textContent, maxWidth);

                // Determine the total number of lines and calculate pages
                const totalLines = lines.length;
                const linesPerPage = (doc.internal.pageSize.height - marginTop - marginBottom) / lineHeight;

                for (let i = 0; i < totalLines; i++) {
                    // If we've reached the lines per page limit, add a new page
                    if (i > 0 && i % linesPerPage === 0) {
                        doc.addPage();
                    }

                    // Calculate the y position for the current line
                    const yPosition = marginTop + (i % linesPerPage) * lineHeight;

                    // Add the current line to the PDF
                    doc.text(lines[i], 10, yPosition);
                }

                // Download the PDF
                doc.save('documento.pdf');
            });


        });

        function getQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const numero = urlParams.get('numero');
            const anno = urlParams.get('anno');
            const festivita = urlParams.get('festivita');
            return { numero, anno, festivita };
        }

        function populatePage(data, numero, anno) {
            const celebrazione = data.celebrazioni.find(celebra => celebra.numero === parseInt(numero));

            if (celebrazione) {
                document.title = `${numero}° domenica tempo ordinario - Anno ${anno}`;
                document.querySelector('#title').innerHTML = `${numero}° DOMENICA DEL TEMPO ORDINARIO - ANNO ${anno}`;
                const colore = celebrazione.colore;
                document.querySelector("#myNavbar").setAttribute("style", `background-color: ${colore};`);
                document.querySelector('#antifona-ingresso').innerHTML = celebrazione.antifona_ingresso;
                document.querySelector('#canto-ingresso').innerHTML = celebrazione.canto_ingresso || "";
                document.querySelector('#atto-penitenziale').innerHTML = celebrazione.atto_penitenziale;
                document.querySelector('#tropo-1').innerHTML = celebrazione.tropo_1;
                document.querySelector('#tropo-2').innerHTML = celebrazione.tropo_2;
                document.querySelector('#tropo-3').innerHTML = celebrazione.tropo_3;
                document.querySelector('#prima-lettura').innerHTML = celebrazione.prima_lettura_testo;
                document.querySelector('#salmo').innerHTML = celebrazione.salmo_testo;

                const link_salmo = celebrazione.salmo_link;
                if (link_salmo) {
                    document.getElementById('link_salmo').setAttribute('href', link_salmo);
                } else {
                    document.getElementById('link_salmo').style.display = 'none';
                }

                document.querySelector('#seconda-lettura').innerHTML = celebrazione.seconda_lettura_testo;
                document.querySelector('#vangelo').innerHTML = celebrazione.vangelo;
                document.querySelector('#canto-offertorio').innerHTML = celebrazione.canto_offertorio;
                document.querySelector('#canto-comunione').innerHTML = celebrazione.canto_comunione;
                document.querySelector('#antifona-alla-comunione').innerHTML = celebrazione.antifona_alla_comunione;
            } else {
                document.body.innerHTML = `<p class="error">Errore: Celebrazione non trovata per numero ${numero} e anno ${anno}.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const { numero, anno, festivita } = getQueryParams();
            let jsonFile = "";
            if (festivita === "ordinario") {
                jsonFile = `db/tempi_liturgici/tempo_ordinario/celebrazioni_anno_${anno.toLowerCase()}.json`;
            } else if (festivita === "natale") {
                // gestisci natale
            } else if (festivita === "avvento") {
                jsonFile = `db/tempi_liturgici/avvento/celebrazioni_anno_${anno.toLowerCase()}.json`;
            } else if (festivita === "quaresima") {
                jsonFile = `db/tempi_liturgici/quaresima/celebrazioni_anno_${anno.toLowerCase()}.json`;
            }
            console.log(jsonFile);
            fetch(jsonFile)
                .then(response => response.json())
                .then(data => {
                    populatePage(data, numero, anno);
                })
                .catch(error => {
                    console.error('Errore nel caricamento del JSON:', error);
                    document.body.innerHTML = `<p class="error">Si è verificato un errore durante il caricamento delle informazioni. Riprova più tardi.</p>`;
                });
        });


    </script>
</head>

<body>
    <div class="navbar" id="myNavbar">
        <h1>Proposta canti</h1>
        <span class="menu-toggle" onclick="toggleMenu()">☰</span>
        <div class="navbar-buttons">
            <button onclick="location.href='index.html'">Home</button>
            <button onclick="location.href='nav-bar/elenco_canti.html'">Elenco canti</button>
            <button onclick="location.href='nav-bar/spartiti_salmi.html'">Spartiti salmi</button>
            <button onclick="location.href='nav-bar/anno_liturgico.html'">Anni liturgici</button>
            <button onclick="location.href='nav-bar/salmi_eventi_speciali.html'">Eventi speciali</button>
            <button onclick="location.href='nav-bar/imp_supporto.html'">Impostazioni/Supporto</button>
        </div>
        <input type="text" placeholder="Cerca...">
    </div>
    <button id="download">Scarica</button>
    <div class="responsive-container">
        <h1 id="title"></h1>

        <h2>Antifona d'ingresso</h2>
        <p id="antifona-ingresso"></p>

        <h3>Canto d'ingresso</h3>
        <p id="canto-ingresso"></p>

        <h2>Atto Penitenziale</h2>
        <p id="atto-penitenziale"></p>

        <p id="tropo-1"></p>
        <p id="tropo-2"></p>
        <p id="tropo-3"></p>

        <h2>Prima Lettura</h2>
        <p id="prima-lettura"></p>

        <h2>Salmo Responsoriale</h2>
        <p><a id="link_salmo" href="" download>Salmo Responsoriale</a></p>
        <p id="salmo"></p>

        <h2>Seconda Lettura</h2>
        <p id="seconda-lettura"></p>

        <h2>Vangelo</h2>
        <p id="vangelo"></p>

        <h3>Canto d'offertorio</h3>
        <p id="canto-offertorio"></p>

        <h3>Canto di comunione</h3>
        <p id="canto-comunione"></p>

        <h2>Antifona alla Comunione</h2>
        <p id="antifona-alla-comunione"></p>

    </div>

    <script>
        function toggleMenu() {
            const navbar = document.getElementById('myNavbar');
            navbar.classList.toggle('active');
        }
    </script>
</body>

</html>